
variables:
  toolsVersion: '1.0.0'
  coreImageName: 'ngcloud/cloud-tools'
  awsImageName: 'ngcloud/aws-tools'
  azureImageName: 'ngcloud/azure-tools'
  awsCreatorName: 'ngcloud/creator'
  azureCreatorName: 'ngcloud/azure-creator'
  notaryVersion: '0.6.1'

pr:
- master
- release/*
- epic/*

trigger:
  batch: true
  branches:
    include:
    - master
    - feature/*
    - epic/*
    - release/*
    exclude:
    - test/*
    - temp/*

jobs:
- job: BuildCore
  displayName: 'Build core container'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: |
      DATE=$(date '+%d/%m/%Y %H:%M:%S')
      echo "##vso[task.setvariable variable=buildDate;]$DATE"
    displayName: 'Set build variables'  
  - script: docker build --build-arg aquaToken=$(aquaToken) --build-arg CLI_VERSION=$(toolsVersion) --build-arg BUILD_DATE="$(buildDate)" -f Dockerfile-tools -t $(coreImageName) --no-cache .
    displayName: 'NgCloud core tools docker build'

- job: BuildAWS
  dependsOn: BuildCore
  displayName: 'Build aws container'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: docker build --build-arg aquaToken=$(aquaToken) --build-arg CLI_VERSION=$(toolsVersion) --build-arg BUILD_DATE="$(buildDate)" -f Dockerfile-aws -t $(awsImageName) --no-cache .
    displayName: 'NgCloud aws tools docker build'
  - script: docker build --build-arg CLI_VERSION=$(toolsVersion) --build-arg BUILD_DATE="$(buildDate)" -f Dockerfile -t $(awsCreatorName) --no-cache .
    displayName: 'NgCloud Creator docker build (AWS)'

- job: BuildAzure
  dependsOn: BuildCore
  displayName: 'Build azure container'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: docker build --build-arg aquaToken=$(aquaToken) --build-arg CLI_VERSION=$(toolsVersion) --build-arg BUILD_DATE="$(buildDate)" -f Dockerfile-azure -t $(azureImageName) --no-cache .
    displayName: 'NgCloud azure tools docker build'
  - script: docker build --build-arg CLI_VERSION=$(toolsVersion) --build-arg BUILD_DATE="$(buildDate)" -f Dockerfile-azcreator -t $(azureCreatorName) --no-cache .
    displayName: 'NgCloud Creator docker build (Azure)'  

- job: PublishCore
  displayName: 'Publish core container'
  pool:
    vmImage: 'Ubuntu 16.04'
  dependsOn: BuildCore
  steps:
  - script: |
      docker login -u $(dockerId) -p $pswd
      docker push $(coreImageName)
    displayName: 'Push docker containers for core cloud tools'
    env:
      pswd: $(dockerPassword)
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))  

- job: PublishAWS
  dependsOn: PublishCore
  displayName: 'Publish AWS container'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: |  
      docker push $(awsImageName)
      docker push $(awsCreatorName)
    displayName: 'Push docker containers for aws creator'    

- job: PublishAzure
  dependsOn: PublishCore
  displayName: 'Build azure container'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: |  
      docker push $(azureImageName)
      docker push $(azureCreatorName)  
    displayName: 'Push docker containers for azure creator'
